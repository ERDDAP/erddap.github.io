このコンテンツは、 [Roy Mendelssohnからのメッセージ ERDDAP ユーザーグループ](https://groups.google.com/g/erddap/c/JWoS_y3cygg/m/zCpcNTxNAAAJ) お問い合わせ

1. クラウド用のnetcdfファイルを最適化
—————————————————————

a. 再梱包とページサイズ

最近、私はこの非常に興味深い記事に遭遇したいくつかの研究を行っている:

https://nsidc.github.io/cloud-optimized-icesat2/

プログラミング言語、編集者、ファイル形式の議論のような情熱を損なうようなものは何もないし、これはフォーマットの推奨ではありません (ツイート) 使うべきではなく、その紙の中のものを理解し、どれだけの改善が得られるかを理解する ( ERDDAP™ 人々が実際にデータを操作する方法を試してみるのではなく、これらの問題の多くについて常に気づいて試みました) お問い合わせ

紙は、主にアマゾンS3などのオブジェクトストアにデータを保存する状況を目的としています。 オブジェクトストアは、ネットワーク上でアクセスされます http  (ツイート) コマンドは、直接接続してストレージに比べて (仮想) サーバは、リクエストが往復をしなければならないので、はるかに長いレイテンシーがあります。 オブジェクトストアでは、できるだけ少数のリクエストを作成したいのですが、実際に大量のリクエストをするだけで、コール数を減らすことができます。必要以上に多くのデータにアクセスできるので、そうでないと均等に遅くなる可能性があります。 そのため、この2つの要因とのバランスをとっていきます。 オブジェクトストアのデータへのアクセスが大幅に向上しましたが、直接添付されたストレージへのアクセスも便利です。 この見積もりを調べるには:

ローカルディスク:
・ 参照の時間: 0.1ms
•6は見ます:0.6ms (必須条件) 
・ scattered メタデータを読むことは速いです
クラウド HTTP:
・ 要求の潜伏: 100-200ms
•6つの要求:600-1200ms (非常に遅い&#33;) 
・ それぞれにネットワークの要求の往復の時間があります

理解する2つ目は、netcdf4/hdf5ファイルがチャンクに保存され、ページ内で返されるため、各々の相対的なサイズは、オブジェクトストアからアクセス速度に本当に影響し、デフォルトでは、ファイルに関するメタデータがファイル全体に散らばっているため、メタデータを取得するにはいくつかのリクエストがかかることがあります。 紙の主な点は、netcdf4/hdf5ファイルのデフォルトページサイズが4096バイトであるということです (4ページ目) ・ (曇り&#33;) メタデータサイズだけでは、これよりも大きい可能性があり、チャンクサイズがこれよりも大きい可能性もあります。 そのため、抽出物は多くの往復が遅い必要があります。 どのメタデータがファイルの「トップ」にあるように、ファイルを再梱包し、ページサイズがメタデータサイズと1つのチャンクのサイズと同じくらい大きいので、ファイルを再梱包します。 また、デフォルトではページサイズは固定されませんが、異なる戦略を使用します。 紙が見つかったのは、固定ページサイズがより良い結果をもたらすことです。

ファイルメタデータのサイズを決定する方法は?

> h5stat yourfile.nc | grep "File metadata" # metadata size
>

チャンクのサイズを決定する方法:

> h5dump -pH MUR41_file.nc | grep -A3 CHUNKED
>

または

> ncdump -sh MUR41_file.nc | grep ChunkSizes
>

ページサイジング戦略を決定する方法:

> h5stat yourfile.nc | grep "File space management strategy"
>

ほとんどの場合、このコマンドはデフォルト戦略である「H5F_FSPACE_STRATEGY_FSM_AGGR」を返し、返したいのは「H5F_FSPACE_STRATEGY_PAGE」です。

すべてのメタデータがフロントにあるように、netcdfファイルを再梱包する方法と、固定ページサイズが使用されるように戦略を変更し、どのページサイズを使用するのか? 私が見つけた親指の規則は次のとおりです。

ページ サイズの選択:
・ 必須ファイル合計メタデータサイズ (重要な&#33;) 
・ 2の力であるべき (4MB・8MB・16MB等) 
・ 大きめに行くしないでください - 32MBは通常、実用的な最大です
・ チャンクサイズを考慮する - ページサイズは最大のチャンクに対応する必要があります

上記のように、理想的にはサイズはメタデータサイズと1つのチャンクのサイズよりも大きいはずです。 どのような研究が見つかったのは、8MBのページサイズが良好なトレードオフである多くのデータセットのために、メタデータサイズ+チャンクサイズよりもおそらく大きく、必要なよりも多くのデータを引き出すことはありません。 これを達成するには:

h5repack -S PAGE -G 8388608 あなたのファイル .nc プロフィール .nc 

ここでは、異なるページサイズを取得するために使用する値は次のとおりです。

4194304の (4m3) 
8388608の特長 (8m3) 
16777216の (16メガバイト) 
33554432の特長 (32MB以上) 

. . ローカルでファイルを使うとメリットはありますか?

私が見つけた紙やその他のものは、10%-30%のどこからでもスピードゲインができることを示唆しています。 私のものの、徹底的なテストでは、リクエストが全体のファイルサイズと比較して比較的小さいときに約10%の速度の上昇が見つかり、リクエストが大きくなるにつれて速度が低下しますが、遅くなることは見つかりませんでした。

ツイート タンスタフ

ところが、どこかの漁場が多いので、無料ランチみたいです。 キャッチは、固定ページのサイズがファイルのサイズを増加させることです。 私が試したケースのいくつかについて:

617Mのmur1 .nc 
632M mur1_最適化 .nc 
608Mのmur2 .nc 
616M mur2_最適化 .nc 
29M クラ1 .nc 
40M chla1_最適化 .nc 
30M chla2 .nc 
40M chla2_最適化 .nc 

そのため、トレードオフはファイルサイズが重要でない増加しています。

. . . しかし、とにかくファイルを再処理する必要がある場合......?

よい質問は、ファイルを再処理するためにスクリプトを書く必要があるのであれば、 zarr という形式に変換するためのスクリプトを書くだけですか? zarrには多くの支持者があり、zarrに興味がある場合は、素早くアヒルダック検索を行い、良い投稿がたくさんあります。おそらくバランスの取れたビューはありますhttps://www.youtube.com/watch?v=IEAcCmcOdJs  (彼が上げているポイントの多くは、アイスチャンク形式が対処しようとしていることです) お問い合わせ そのため、定期的にnetcdfファイルを作成する場合は、ファイルをzarrのようなものに翻訳したくないかもしれませんが、今からファイルを最適化し始めることができます。これにより、速度が向上し、過去のファイルを再フォーマットする必要はありません。 ERDDAP™ 内部設定が異なるにもかかわらず、ファイルを集計することができます。 次に、netcdfファイルに依存するツールがたくさんあるかもしれません。このアプローチは、広範囲の量のコードである可能性があることを再ツールする必要はありません。 オプションを意識し、あなたの状況に最適な作品を選ぶ点です。 リマインダーとして、 zarr ファイルを と 使用するかどうか ERDDAP™ , v2 ファイルを zarr 形式でなければなりません。

例) ビッグデータ - 片側

ビッグデータは、多くのことについて話していますが、ほとんどの人が使用するデータと、現代のラップトップの能力とどのように比較するのかが大きかったです。 (はい ノートパソコン、サーバーではなく) お問い合わせ 興味深いテイクは:

https://www.youtube.com/watch?v=GELhdezYmP0話全体が面白かったが、約37分スタート

彼が言及する研究は次のとおりです。

https://motherduck.com/blog/redshift-files-hunt-for-big-data/

そのため、実際にパワーをクランクアップする必要があるユーザーの比較的小さな割合がありますが、圧倒的多数のユーザーがノートパソコン上で分析を行うことができます。26TBの外部ドライブは現在$ 300未満であり、噂は60TBの外部ドライブが年末までに利用可能であるということです。 お問い合わせ

2. 使用方法 ERDDAP™ AWS 以外の Google Cloud プラットフォームまたはその他のクラウドプロバイダー
--------------------------------------------------------------------------------------------------------------------------------------

瞬間に ERDDAP™ AWSオブジェクトストアでしか動作しない (S3シリーズ) 、改善し、一般化しているが ERDDAP™ 's オブジェクトストアのサポートは todo リストにあります (詳しくはこちらhttps://github.com/ERDDAP/erddap/issues/158) お問い合わせ だから、あなたがあなたの実行しなければならないと言った場合は何をすべきか ERDDAP™ Googleクラウドプラットフォーム (GCPの特長) または同様のプラットフォーム? まず、ほとんどのクラウドプラットフォームは、通常、ローカルストレージに似ているものを含むストレージの異なるレベルを提供し、オペレーティングシステムによって認識され、ネットワーク上で接続されているものは通常、NFSを使用してアクセス (OSから直接アクセス可能) オブジェクトストアである。 最初の解決策は、オブジェクトストアを使用しないし、行くのは良いでしょう。 しかし、いつものように、TANSTAAFLとこのケースの欠点は、オブジェクトストアから行くのと同じです -&gt; NFSアクセス → ローカルストアでコストも上昇します。 (NFS はネットワーク上でもアクセスし、独自のレイテンシの問題も追加します。これはファイルの最適化にも役立ちます。) お問い合わせ

オブジェクトストアを使用する必要がある場合、またはオブジェクトストアだけを手に入れることができれば、答えはFUSEファイルシステムです。 (https://github.com/libfuse/libfuse) お問い合わせ GCP では、これは gcsfuse と呼ばれ、インストールする手順は次のとおりです。

•GCP Linuxイメージにgsfuseをインストールします。
sudo aptアップデート
sudo apt インストール gcsfuse
• GCP への認証 (既に認証されていない場合) : : :
通常、サービスアカウントまたはgcloud authのログインを実行することで、適切な資格情報を持っていることを確認してください。
・ GCS バケットをローカルディレクトリにマウントします。
GCS バケットを gcsfuse を使用してローカルディレクトリにマウントします。 これにより、GCP インスタンスがローカルファイルシステムの一部であったかのようにデータにアクセスすることができます。
gcsfuse ユーザー名 /path/to/mount/directory

これで、オブジェクトストアは Linux のファイルシステムの一部であるようにアクセスすることができます。 ERDDAP™ お問い合わせ これは魔法のように思える, 両方の世界の最高のを取得, キャッチする必要があります。. そしてあります。 FUSEファイルシステムは、オブジェクトストアに直接アクセスするよりも少し遅くなります (基本的には別のレイヤーをアクセスに追加しました) お問い合わせ 私の研究では、マップ全体にどれだけ遅くなるかを推定するので、どのくらい遅くなるかはわかりません。 しかし、オブジェクトストアを使用してGCPで実行しなければならない状況にある場合、あなたは今、それが動作するソリューションを持っています ERDDAP™ お問い合わせ

3. 助けるために今できること。
—————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

これらのことのいくつかをテストし、あなたの結果に報告する時間と能力を持っているなら、それは素晴らしいでしょう。 特に、GCP や類似性にアクセスし、どのくらいの遅くなるかを確認している場合 ERDDAP™ アクセスはFUSEを利用しています (AWSでも実際にテストできます。) お問い合わせ 速度のペナルティがあまりにも素晴らしいことではない場合, それは素晴らしいだろう, 私は何人かの人々を信じる理由を持っているので、すぐに自分の実行する必要があります ERDDAP™ s on GCP オブジェクトストアで。 そのため、理論的な関心の問題だけではありません。
