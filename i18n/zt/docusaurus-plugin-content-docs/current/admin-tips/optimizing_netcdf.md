此內容基于 [羅伊·門德爾索恩致 ERDDAP 使用者群組](https://groups.google.com/g/erddap/c/JWoS_y3cygg/m/zCpcNTxNAAAJ) .

1. 优化 netcdf 云文件
... ... ...

a. 重新包装和頁面大小

最近在做一些研究時, 我發現這篇文章很有趣:

https://nsidc.github.io/cloud-optimized-icesat2/

似乎沒有什麼能激起熱情的, 如討論程式語言、編輯器與檔案格式, (s) 你該用,但要明白那篇報紙上寫的是什么 看看能有多大的改善 ( ERDDAP™ 總想對很多這些事視而不見,) .

本文主要指數據存放在亞馬遜S3等物件商店的情況. 使用 http  (s) 命令,比起直接連接到 (虛擬) 伺服器中, 要求需要來回旅行的空間要長得多 。 對於物件商店,您希望提出尽可能多的要求, 但是如果你只是提出真正的大要求以減少呼叫數量, 您可能會取得比您需要的多得多的數據, 如果不是更多, 這可能會很慢 。 因此,技術就是要在这两个因素之间取得平衡. 雖然對物件商店資料的存取有很大的改善, 在研究中,一些估算如下:

本地磁碟 :
· 尋找時間: 0.1ms
• 6次搜索:0.6米 (可忽略) 
· 讀取分散的中繼資料的速度快
云HTTP:
· 要求逾期: 100-200ms
6份要求:600-1200毫秒 (非常慢&#33;) 
· 每個要求都有網路往返時間

第二件事是 netcdf4/hdf5 檔案被儲存在區塊中並以頁面傳回, 所以當存取到物件商店時, 每個檔案的相對大小會真正影響存取速度, 並且預設時, 檔案的中繼資料會分散在檔案中, 所以取得中繼資料可能會需要多個要求 。 文件的重點是 netcdf4/hdf5 檔案的預設頁面大小是 4096 位元組 (4KB) - – (云何的可怕&#33;) 因為光是元件大小就可能比這個大 而且你的大塊大小也比這個大 所以抽取要花很多時間 才會很慢 您要做的是重新包裝檔案, 讓所有中繼資料都放在檔案的「 頂端」 , 頁面大小至少和中繼資料大小一樣大, 加上一個區塊的大小 。 此外, 頁面大小也不固定, 而是使用不同的策略 。 本文使用固定的頁面大小,

我怎麼才能決定檔案中繼資料大小?

> h5stat yourfile.nc | grep "File metadata" # metadata size
>

我如何決定大小:

> h5dump -pH MUR41_file.nc | grep -A3 CHUNKED
>

或

> ncdump -sh MUR41_file.nc | grep ChunkSizes
>

我如何決定頁面大小策略:

> h5stat yourfile.nc | grep "File space management strategy"
>

此命令很可能會傳回「 H5F_ FSPACE_ SratateGY_ FSM_ AGGR 」 , 這是預設的策略, 我們要傳回的是「 H5F_ FSPACE_ SratateGY_ PAGE 」 。

如何重新包裝我的網頁檔案, 讓所有中繼資料都放在前面, 並改變策略, 以便使用固定的頁面大小, 以及要使用的頁面大小 ? 我找到的拇指規則是:

頁面大小選擇 :
· 必須是 Q 檔案總元大小 (非常危險&#33;) 
· 應該是2的力量 (4MB,8MB,16MB等.) 
· 通常32MB是實際上最大的
· 考慮區塊大小 - 頁面大小應包含最大區塊

如上所述, 理想的大小應該大于元件大小加一個區塊的大小。 研究發現, 對很多數據集來說, 8MB頁面大小是一個很好的取舍, 它可能比元数据大小+ 區塊大小大, 为实现此目的:

h5repack - S PAGE - G 8388608 您的文件 .nc 您的文件优化(_T) .nc 

以下是不同頁面大小的數值 :

4194304 (4MB) 
8388608 (8MB) 
16777216 (16MB) 
33554432 (32MB) 

b. 如果在本地使用檔案, 是否有益處 ?

我發現的報紙和其他東西顯示, 即使當地也有10%-30%的速度增長。 我發現, 相較於檔案的大小, 要求的增速會減慢, 但我從未發現它會減慢。

丙. 坦斯塔夫

啊,但總有一些地方, 這似乎是免費的午餐。 而捕捉到的是固定的頁面大小增加了檔案的大小. 我試過的一些案子:

617M mur1 .nc 
632M mur1_优化 .nc 
608M mur2 .nc 
616M mur2_优化 .nc 
29M chla1 .nc 
40M chla1_优化 .nc 
30M chla2 .nc 
40M chla2_优化 .nc 

所以要取舍的是 檔案的大小有不小的增長

d. 但如果我要重新處理檔案...

一個好問題是,如果我需要寫一個腳本來重新處理檔案, 為什麼不只寫一個腳本來翻譯成像說zarr那樣的格式呢? Zarr有很多支持者 如果你對Zarr有興趣 就做個快速的Duckuckgo搜索 還有很多好文章https://www.youtube.com/watch?v=IEAcCmcOdJs  (有趣的是,他提出的很多點是 冰球格式想要處理的) . 為何你不想將您的檔案翻譯成 zarr, 首先, 如果你能定期建立 netcdf 檔案, 你可以從現在開始优化檔案, 隨著時間推移, 這些檔案會看到速度的增強, 並且你不必重寫過去的檔案, ERDDAP™ 即使有些內部設定不同, 仍能對檔案进行聚合 。 第二,你可能有很多工具要依靠Netcdf文件, 而這個方法就意味著不需要重新調整可能大量編碼。 重點是了解一些選擇, 就像提醒,如果你選擇使用 Zarr 文件 ERDDAP™ ,它們必須是 zarr 格式 v2 檔案 。

e. 大數據 - 邊緣

但大多數人使用的數據有多大, (是手提電腦,不是伺服器) . 有趣的是:

https://www.youtube.com/watch?v=GELhdezYmP0從37分鐘開始,雖然整句都很有趣

他提到的研究是:

https://motherduck.com/blog/redshift-files-hunt-for-big-data/

26TB的外部驅動器已經不足300美元, 傳言到年底將有60TB的外部驅動器。 想想吧

2. 使用 ERDDAP™ 和 Google 雲端或 AWS 之外的其他云端提供商
——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

目前 ERDDAP™ 已知只與 AWS 物件商店合作 (S3) ,但有所改进和概括 ERDDAP™ 待辦事項清單中包含物件儲存支持 (你看https://github.com/ERDDAP/erddap/issues/158) . 如果你被告知要跑,怎麼辦? ERDDAP™ 在 Google 雲端 (GCP 磁碟) 或相似的平台? 首先,大多云平台提供不同的儲存水平,通常包括一個與本地儲存相似且被操作系統認同的平台,一個在網路上連通的平台通常使用NFS來存取 (由OS直接存取) ,而一個是物件商店。 第一個解決辦法是不要使用物件商店 你可以走了 但和往常一樣 TANSTAAFL 和這個案子的缺陷 就是你從物件商店走出來的 - &gt; NFS 存取 - &gt; 本地商店您的成本也上升 。 (我還要說NFS也透過網路存取,) .

如果您需要使用物件商店, 或是只付得起物件商店, 答案是 FUSE 文件系統 (https://github.com/libfuse/libfuse) . 在GCP上,這叫做gcsfuse,安裝它的步骤是:

在您的 GCP Linux 影像上安裝 gcsfuse :
sudo 完美更新
sudo apt 安裝 gcsfuse
• 认证到GCP (如果尚未驗證) :
確保您有正確的憑證, 通常是通過服務帳號或執行 gcloud auth 登入 。
· 將 GCS 桶載入本地目錄 :
用 gcsfuse 將您的 GCS 桶載入本地目錄 。 這可以讓您的 GCP 實驗存取資料, 好像它是本地檔案系統的一部分 。
gcsfuse your- bucket- name / path/ to/ mount/ directory / path/ mount/ direct

您的物件商店現在可以被存取了, 好像它是 Linux 文件系統的一部分, 所以會與它合作 ERDDAP™ . 這似乎是魔力, 得到最好的兩個世界, 一定有抓住。 有的 FUSE 文件系統比直接存取物件商店慢得多 (基本上您在存取中新增了另一層) . 我對地圖上慢得多的估計, 但如果你處於 使用物件商店執行 GCP 的境地, 您現在有解決方案可以效法 ERDDAP™ .

3. 你現在能做的就是幫忙
—————————————————————

如果你有時間和能力 試驗一些這些東西 并報告你的結果,那就太好了。 尤其是如果你有GCP或類似的權限 看看有多慢 ERDDAP™ 存取使用 FUSE (你也可以在AWS上試試這個) . 如果速度不是太快 那太好了 因為我有理由相信有些人很快就得跑 ERDDAP™ s 在 GCP 與物件商店。 所以這不僅是理論上的利益
